<% function getUser(uid) { for(let __user of users) { if(__user.uid === uid) {
return __user; } } return null; } %> <% function getTopics(_categoryId) { const
__topics = []; for(let __topic of topics) { if(__topic.parent === _categoryId)
__topics.push(__topic); } return __topics; } %>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <% include ../imports/head.ejs %>
    <title>Admin</title>
  </head>
  <body>
    <% include ../imports/sidenav.ejs %> <% include ../imports/navbar.ejs %>
    <div class="container">
      <div class="row">
        <div class="col s12">
          <ul class="tabs">
            <li class="tab col s3">
              <a class="active" href="#sisu"><b>Sisu</b></a>
            </li>
            <li class="tab col s3">
              <a href="#kasutajad"><b>Kasutajad</b></a>
            </li>
            <li class="tab col s3">
              <a href="#tagasiside"><b>Tagasiside</b></a>
            </li>
            <li class="tab col s3">
              <a href="#saavutused"><b>Saavutused</b></a>
            </li>
          </ul>
        </div>
      </div>
      <div id="sisu">
        <h4>Sisu</h4>
        <div>
          <ul class="collapsible">
            <% for(let {title, id, last_changed} of categories) { %>
            <li>
              <div class="collapsible-header">
                <h6 class="left"><%= title %></h6>
              </div>
              <div class="collapsible-body table">
                <table>
                  <thead>
                    <tr>
                      <th>Teema</th>
                      <th>ID</th>
                      <th>Muutmise aeg</th>
                      <th>Vaata</th>
                      <th>Redigeeri</th>
                      <th>Kustuta</th>
                    </tr>
                  </thead>
                  <tbody class="collapsible">
                    <% for(let topic of getTopics(id)) { %>
                    <tr>
                      <td><%= topic.title %></td>
                      <td><%= topic.id %></td>
                      <td><%= topic.last_changed %></td>
                      <td>
                        <a
                          href="/teemad/<%= id %>/<%= topic.id %>"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="btn green"
                          >Vaata</a
                        >
                      </td>
                      <td>
                        <a
                          href="/admin/edit_topic/<%= id %>:<%= topic.id %>"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="btn orange"
                          >Redigeeri</a
                        >
                      </td>
                      <td>
                        <form
                          method="POST"
                          action="/admin/del_top"
                          onsubmit="return confirm('Kindel, et kustutada <%= topic.title %>?')"
                        >
                          <input
                            type="hidden"
                            name="id"
                            value="<%= id %>:<%= topic.id %>"
                          />
                          <input
                            type="submit"
                            value="Kustuta"
                            class="btn red"
                          />
                        </form>
                      </td>
                    </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </li>
            <% } %>
          </ul>
        </div>
        <a class="btn modal-trigger green" href="#add_cat_modal">
          Lisa uus kategooria
        </a>
        <a class="btn modal-trigger green" href="#add_top_modal">
          Lisa uus teema
        </a>
        <div class="modal" id="add_cat_modal">
          <h5>Lisa uus kategooria</h5>
          <form method="POST" action="/admin/add_cat">
            <table>
              <tr>
                <td>Kategooria</td>
                <td>
                  <input type="text" name="title" id="add-cat-title" required />
                </td>
              </tr>
              <tr>
                <td>ID</td>
                <td>
                  <input type="text" name="id" id="add-cat-id" required />
                </td>
              </tr>
              <tr>
                <td><input type="submit" value="Lisa" class="btn green" /></td>
              </tr>
            </table>
          </form>
        </div>
        <div class="modal" id="add_top_modal">
          <h5>Lisa uus teema</h5>
          <form action="/admin/add_top" method="POST">
            <table>
              <tr>
                <td>Pealkiri</td>
                <td>
                  <input type="text" name="title" id="add-top-title" required />
                </td>
              </tr>
              <tr>
                <td>ID</td>
                <td>
                  <input type="text" name="id" id="add-top-id" required />
                </td>
              </tr>
              <tr>
                <td>Kategooria</td>
                <td>
                  <select name="category" id="add-top-cat" required>
                    <option value="" disabled selected>Vali kategooria</option>
                    <% for(let category of categories) { %>
                    <option value="<%= category.id %>">
                      <%= category.title %>
                    </option>
                    <% } %>
                  </select>
                </td>
              </tr>
              <tr>
                <td><input type="submit" value="Lisa" class="btn green" /></td>
              </tr>
            </table>
          </form>
        </div>
      </div>
      <div id="kasutajad">
        <h4>Kasutajad</h4>
        <div class="table">
          <table>
            <thead>
              <tr>
                <th>Nimi</th>
                <th>UID</th>
                <th>Email</th>
                <th>Admin</th>
              </tr>
            </thead>
            <tbody>
              <% for(let {displayName, uid, email, admin} of users) { %>
              <tr>
                <td><%= displayName %></td>
                <td><%= uid %></td>
                <td><%= email %></td>
                <td>
                  <form
                    action="/admin/<% if(admin) { %>del<% } else { %>add<% } %>_adm"
                    method="post"
                  >
                    <input type="hidden" name="uid" value="<%= uid %>" />
                    <div class="switch">
                      <label>
                        Off <% if(admin) { %>
                        <input
                          type="checkbox"
                          onchange="this.form.submit()"
                          checked
                        />
                        <% } else { %>
                        <input type="checkbox" onchange="this.form.submit()" />
                        <% }%> <span class="lever"></span> On
                      </label>
                    </div>
                  </form>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <h4>Sessioonid</h4>
        <a href="/admin/refresh_sessions">Kustuta aegunud sessioonid</a>
        <div class="table">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Kasutaja</th>
                <th>Loomisaeg</th>
              </tr>
            </thead>
            <tbody>
              <% for(let {id, uid, created_at} of sessions) { %>
              <tr>
                <td><%= id %></td>
                <td><%= getUser(uid).displayName %></td>
                <td><%= created_at %></td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
      <div id="tagasiside">
        <h4>Tagasiside</h4>
        <div class="table">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>UID</th>
                <th>Aeg</th>
                <th>Nimi</th>
                <th>Sisu</th>
                <th>Kustuta</th>
              </tr>
            </thead>
            <tbody>
              <% for(let {id, uid, timestamp, name, text} of feedback) { %>
              <tr>
                <td><%= id %></td>
                <td><%= uid %></td>
                <td><%= timestamp %></td>
                <td><%= name %></td>
                <td><%= text %></td>
                <td>
                  <form
                    method="POST"
                    action="/admin/del_fdb"
                    onsubmit="return confirm('Kindel, et kustutada <%= name %>?')"
                  >
                    <input type="hidden" name="id" value="<%= id %>" />
                    <input type="submit" value="Kustuta" class="btn red" />
                  </form>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
      <div id="saavutused">
        <h4>Saavutused</h4>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Pealkiri</th>
              <th>Kirjeldus</th>
              <th>Viimati muudetud</th>
              <th>Redigeeri</th>
              <th>Kustuta</th>
            </tr>
          </thead>
          <tbody>
            <% for(let {id, title, description, last_changed} of achievements) {
            %>
            <tr>
              <td><%= id %></td>
              <td><%= title %></td>
              <td><%= description.substring(0, 50) %></td>
              <td><%= last_changed %></td>
              <td>
                <a
                  href="/admin/edit_achievement/<%= id %>"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="btn orange"
                  >Redigeeri</a
                >
              </td>
              <td>
                <form
                  method="POST"
                  action="/admin/del_ach"
                  onsubmit="return confirm('Kindel, et kustutada <%= title %>?')"
                >
                  <input type="hidden" name="id" value="<%= id %>" />
                  <input type="submit" value="Kustuta" class="btn red" />
                </form>
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
        <a class="btn modal-trigger green" href="#add_ach_modal">
          Lisa uus saavutus
        </a>
        <div class="modal" id="add_ach_modal">
          <h5>Lisa uus saavutus</h5>
          <form action="/admin/add_ach" method="POST">
            <table>
              <tr>
                <td>ID</td>
                <td>
                  <input type="text" name="id" id="add-ach-id" required />
                </td>
              </tr>
              <tr>
                <td>Pealkiri</td>
                <td>
                  <input type="text" name="title" id="add-ach-title" required />
                </td>
              </tr>
              <tr>
                <td>Kirjeldus</td>
                <td>
                  <div class="input-field">
                    <textarea
                      id="add-ach-desc"
                      name="description"
                      class="materialize-textarea"
                    ></textarea>
                  </div>
                </td>
              </tr>
              <tr>
                <td><input type="submit" value="Lisa" class="btn green" /></td>
              </tr>
            </table>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
